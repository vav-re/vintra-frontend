let state={currentView:null,currentPatientId:null,currentDocumentId:null,currentDocumentType:null,activePatientTab:"summary-panel",activeDimensionalView:"radar",activeNewDocumentTab:"record",activeResultsTab:"transcription-panel",isProcessing:!1,isRecording:!1,recordingStartTime:null,recordingInterval:null,audioContext:null,analyser:null,visualizerSource:null,visualizerRafId:null,mediaRecorder:null,audioChunks:[],uploadedFile:null,processedAudioBlob:null,dimensionalData:{emocional:{valencia:-2.5,excitacao:7,dominancia:3,intensidade:8},cognitiva:{complexidade:6,coerencia:5,flexibilidade:4,dissonancia:7},autonomia:{perspectivaTemporal:{passado:7,presente:3,futuro:2,media:4},autocontrole:4}},documents:[],recentPatients:[],transcriptionText:`Entrevista Clínica - 04 de Abril de 2025
Médico: Bom dia, Maria. Como você está se sentindo hoje?
Paciente: Ah, doutor... não estou bem. A dor continua, sabe? Eu tomo os remédios, mas parece que não adianta muito. Durmo mal, acordo cansada. Às vezes acho que nunca vou melhorar. (Suspira) É difícil manter a esperança.
Médico: Entendo que seja difícil, Maria. Vamos conversar sobre isso. Além da dor física, como está o seu ânimo?
Paciente: Péssimo. Me sinto desanimada, sem vontade de fazer nada. Até as coisas que eu gostava perderam a graça. Parece que estou carregando um peso enorme.`,vintraText:`# Análise VINTRA - Maria Silva (04/04/2025)

## Dimensões Emocionais
- Valência (v₁): -2.5 (Negativa)
- Excitação (v₂): 7.0 (Alta)
- Dominância (v₃): 3.0 (Baixa)
- Intensidade (v₄): 8.0 (Alta)

... (restante do texto VINTRA)`,soapText:`# Nota SOAP - Maria Silva (04/04/2025)

## S (Subjetivo)
Paciente relata persistência da dor...

... (restante do texto SOAP)`,ipissimaText:`# Ipíssima Narrativa - Maria Silva (04/04/2025)

Eu não aguento mais essa dor...

... (restante do texto Ipíssima)`,narrativeText:`# Análise Narrativa - Maria Silva (04/04/2025)

## Temas Centrais:
- Dor crônica...

... (restante da análise narrativa)`,orientacoesText:`# Orientações - Maria Silva (04/04/2025)

1. **Medicação:** Continue...

... (restante das orientações)`};function setupEventListeners(){setupLogin(),setupNavigation(),setupSidebar(),setupMobileMenu(),setupPatientTabs(),setupDimensionalVisualizations(),setupDocumentEditing(),setupNewDocumentTabs(),setupRecorder(),setupUpload(),setupTranscriptionInput(),setupProcessing(),setupResultsView(),setupDocumentLibrary(),setupGenericModal();var e=document.getElementById("viewTranscriptionBtn"),e=(e&&e.addEventListener("click",viewTranscription),document.getElementById("processTranscriptionBtn")),e=(e&&e.addEventListener("click",processTranscription),document.getElementById("uploadViewTranscriptionBtn")),e=(e&&e.addEventListener("click",viewTranscription),document.getElementById("uploadProcessTranscriptionBtn")),e=(e&&e.addEventListener("click",processTranscription),document.getElementById("manualViewTranscriptionBtn")),e=(e&&e.addEventListener("click",viewTranscription),document.getElementById("manualProcessTranscriptionBtn")),e=(e&&e.addEventListener("click",processTranscription),document.getElementById("viewResultsBtn")),e=(e&&e.addEventListener("click",()=>window.switchView("results")),document.getElementById("processWithAIButton"));e&&e.addEventListener("click",processDocumentWithAI)}function loadDemoData(){state.recentPatients=[{id:"patient-1",name:"Maria Silva",age:38,gender:"Feminino",lastVisit:"28/03/2025",status:"Em tratamento"},{id:"patient-2",name:"João Santos",age:42,gender:"Masculino",lastVisit:"25/03/2025",status:"Primeira consulta"},{id:"patient-3",name:"Ana Oliveira",age:29,gender:"Feminino",lastVisit:"20/03/2025",status:"Em tratamento"},{id:"patient-4",name:"Carlos Pereira",age:55,gender:"Masculino",lastVisit:"15/03/2025",status:"Retorno"}],state.documents=[{id:"doc1",patientId:"patient-1",title:"Entrevista_Maria_2503.mp3",type:"audio",date:"25/03/2025",time:"10:30",icon:"fas fa-microphone",color:"var(--accent-vivid)",size:"15.3 MB",duration:"28:45"},{id:"doc2",patientId:"patient-1",title:"Transcrição_Maria_2503.txt",type:"transcription",date:"25/03/2025",time:"10:35",icon:"fas fa-file-alt",color:"var(--accent)",size:"5 KB"},{id:"doc3",patientId:"patient-1",title:"VINTRA_Maria_2503.txt",type:"vintra",date:"25/03/2025",time:"10:40",icon:"fas fa-clipboard-list",color:"var(--accent)",size:"8 KB"},{id:"doc4",patientId:"patient-1",title:"SOAP_Maria_2503.txt",type:"soap",date:"25/03/2025",time:"10:45",icon:"fas fa-notes-medical",color:"var(--success)",size:"3 KB"},{id:"doc7",patientId:"patient-1",title:"Ipissima_Maria_2503.txt",type:"ipissima",date:"25/03/2025",time:"10:50",icon:"fas fa-comment-dots",color:"var(--accent-pink)",size:"2 KB"},{id:"doc8",patientId:"patient-1",title:"Narrativa_Maria_2503.txt",type:"narrative",date:"25/03/2025",time:"10:55",icon:"fas fa-book-open",color:"var(--warning-yellow)",size:"4 KB"},{id:"doc9",patientId:"patient-1",title:"Orientacoes_Maria_2503.txt",type:"orientacoes",date:"25/03/2025",time:"11:00",icon:"fas fa-list-check",color:"#8B5CF6",size:"1 KB"},{id:"doc5",patientId:"patient-2",title:"Consulta_Joao_2503.wav",type:"audio",date:"25/03/2025",time:"11:00",icon:"fas fa-microphone",color:"var(--accent-vivid)",size:"22.1 MB",duration:"35:10"},{id:"doc6",patientId:"patient-2",title:"Transcricao_Joao_2503.txt",type:"transcription",date:"25/03/2025",time:"11:05",icon:"fas fa-file-alt",color:"var(--accent)",size:"7 KB"},{id:"doc10",patientId:"patient-4",title:"Retorno_Carlos_1503.mp3",type:"audio",date:"15/03/2025",time:"09:00",icon:"fas fa-microphone",color:"var(--accent-vivid)",size:"10.1 MB",duration:"15:20"}],console.log("Dados de demonstração carregados.")}function renderPatientSelectionOnDashboard(){var e=document.getElementById("dashboard-view");if(e){var a=e.querySelector(".patient-selection-section"),a=(a&&a.remove(),e.querySelector(".welcome-message")),a=(a&&a.remove(),e.querySelector("#recentDocuments")),a=(a&&a.remove(),document.createElement("div")),n=(a.className="patient-selection-section",document.createElement("div")),n=(n.className="section-header",n.innerHTML='<h2 class="section-title">Aceder Paciente</h2>',a.appendChild(n),document.createElement("div"));n.className="search-container dashboard-search",n.innerHTML=`
        <div class="search-bar">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="dashboardPatientSearch" placeholder="Buscar paciente por nome ou ID..." class="search-input">
        </div>
    `,a.appendChild(n);let o=document.createElement("div");o.id="dashboardPatientList",o.className="patient-card-list",a.appendChild(o);n=e.querySelector(".dashboard-header");n?e.insertBefore(a,n.nextSibling):e.prepend(a);let t=document.getElementById("dashboardPatientSearch");if(t){let e=(e="")=>{o.innerHTML="";let t=e.toLowerCase().trim();e=state.recentPatients.filter(e=>!t||-1!==e.name.toLowerCase().indexOf(t)||-1!==e.id.indexOf(t));0===e.length?o.innerHTML='<p class="empty-list-message">Nenhum paciente encontrado.</p>':e.forEach(t=>{var e=document.createElement("div"),a=(e.className="patient-card dashboard-patient-card",e.dataset.id=t.id,e.innerHTML=`
                <div class="patient-card-header">
                    <div class="patient-avatar">
                        ${escapeHtml(t.name.charAt(0))}
                    </div>
                    <div class="patient-card-details">
                        <div class="patient-card-name">${escapeHtml(t.name)}</div>
                    </div>
                </div>
                <div class="patient-card-info">
                    ID: ${escapeHtml(t.id)}
                </div>
                <button class="btn btn-secondary access-patient-btn">Aceder</button>
            `,e.querySelector(".access-patient-btn"));a&&a.addEventListener("click",e=>{e.stopPropagation(),window.openPatientPanel(t.id)}),o.appendChild(e)})};t.addEventListener("input",debounce(()=>e(t.value),300)),e()}else console.error("Elemento de busca de paciente no dashboard não encontrado.")}}function renderRecentDocuments(){let a=document.getElementById("recentDocuments");var e;a&&(a.innerHTML="",0===(e=state.documents.slice(-4).reverse()).length?a.innerHTML='<p class="empty-list-message">Nenhum documento recente encontrado.</p>':e.forEach(e=>{var t=document.createElement("div");t.className="recent-item",t.dataset.id=e.id,t.innerHTML=`
            <div class="recent-item-icon">
                <i class="${e.icon}"></i>
            </div>
            <div class="recent-item-info">
                <div class="recent-item-title">
                    ${escapeHtml(e.title)}
                </div>
                <div class="recent-item-meta">
                    <span>${escapeHtml(e.type)}</span>
                    <span class="recent-item-meta-divider"></span>
                    <span>${escapeHtml(e.date)}</span>
                    ${e.size?`<span class="recent-item-meta-divider"></span><span>${escapeHtml(e.size)}</span>`:""}
                </div>
            </div>
        `,t.addEventListener("click",()=>{window.switchView("library"),setTimeout(()=>{setActiveDocumentItem(e.id),viewDocumentInWorkspace(e.id)},400)}),a.appendChild(t)}))}function renderDocumentLibrary(a="all",e=""){let n=document.getElementById("documentList");var o=document.getElementById("library-view");if(n&&o)if(state.currentPatientId){(o=document.querySelector('.sidebar-link[data-target="library"]'))&&o.classList.remove("disabled"),n.innerHTML="";let t=e.toLowerCase().trim();o=state.documents.filter(e=>!(e.patientId!==state.currentPatientId||"all"!==a&&e.type!==a||t&&-1===e.title.toLowerCase().indexOf(t))).sort((e,t)=>parseDate(t.date,t.time).getTime()-parseDate(e.date).getTime());0===o.length?(n.innerHTML=`<p class="empty-list-message">Nenhum documento encontrado para este paciente ${"all"!==a||e?"com os filtros aplicados":""}.</p>`,"library"===state.currentView&&showEmptyDocumentView()):(o.forEach(t=>{var e=document.createElement("div"),a=(e.className="document-item document-"+t.type,e.dataset.id=t.id,e.dataset.type=t.type,"audio"===t.type||"transcription"===t.type),o=-1!==["transcription","vintra","soap","ipissima","narrative","orientacoes"].indexOf(t.type),o=(e.innerHTML=`
            <div class="document-icon">
                <i class="${t.icon}"></i>
            </div>
            <div class="document-info">
                <div class="document-title">
                    ${escapeHtml(t.title)}
                </div>
                <div class="document-meta">
                    ${escapeHtml(t.date)}
                </div>
            </div>
            <div class="document-actions">
                <button class="document-action-btn view-doc-modal" title="Visualizar"><i class="fas fa-eye"></i></button>
                ${o?'<button class="document-action-btn edit-doc" title="Editar"><i class="fas fa-edit"></i></button>':""}
                ${a?'<button class="document-action-btn process-doc" title="Processar"><i class="fas fa-cogs"></i></button>':""}
                <button class="document-action-btn download-doc" title="Download"><i class="fas fa-download"></i></button>
            </div>
        `,e.addEventListener("click",()=>{setActiveDocumentItem(t.id),viewDocumentInWorkspace(t.id)}),e.querySelector(".view-doc-modal")),a=(o&&o.addEventListener("click",e=>{e.stopPropagation(),viewDocument(t.id)}),e.querySelector(".edit-doc")),o=(a&&a.addEventListener("click",e=>{e.stopPropagation(),editDocument(t.id)}),e.querySelector(".process-doc")),a=(o&&o.addEventListener("click",e=>{e.stopPropagation(),startProcessingDocument(t.id)}),e.querySelector(".download-doc"));a&&a.addEventListener("click",e=>{e.stopPropagation(),downloadDocument(t.id)}),n.appendChild(e)}),state.currentDocumentId&&o.some(e=>e.id===state.currentDocumentId)?setActiveDocumentItem(state.currentDocumentId):"library"===state.currentView&&(state.currentDocumentId=null,showEmptyDocumentView()))}else n.innerHTML='<p class="empty-list-message">Selecione um paciente no Dashboard para ver os seus documentos aqui.</p>',showEmptyDocumentView(),(e=document.querySelector('.sidebar-link[data-target="library"]'))&&e.classList.add("disabled")}function setActiveDocumentItem(e){document.querySelectorAll("#documentList .document-item, #patientDocuments .document-item").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(`#documentList .document-item[data-id="${e}"], #patientDocuments .document-item[data-id="${e}"]`).forEach(e=>{e.classList.add("active")}),state.currentDocumentId=e,console.log("Documento ativo: "+e)}function viewDocumentInWorkspace(t){var a=state.documents.find(e=>e.id===t),e=document.getElementById("documentView");if(a&&e)if("library"===state.currentView&&a.patientId!==state.currentPatientId)console.warn("Tentativa de visualizar documento de outro paciente na library view."),showEmptyDocumentView();else{console.log(`Visualizando documento: ${a.title} (ID: ${t}, Tipo: ${a.type})`);var o=getDocumentContent(a.type)??`Conteúdo para '${a.type}' não encontrado.`,n=-1!==["transcription","vintra","soap","ipissima","narrative","orientacoes"].indexOf(a.type),i="audio"===a.type||"transcription"===a.type,s=(e.innerHTML="",document.createElement("div")),n=(s.className="document-toolbar",s.innerHTML=`
        <div class="document-info-header">
            <div class="document-info-icon document-${a.type}">
                <i class="${a.icon}"></i>
            </div>
            <div class="document-info-details">
                <h2>${escapeHtml(a.title)}</h2>
                <div class="document-info-meta">
                    <span>${escapeHtml(a.type)}</span>
                    <span class="document-info-meta-divider"></span>
                    <span>${escapeHtml(a.date)} ${escapeHtml(a.time||"")}</span>
                    ${a.size?`<span class="document-info-meta-divider"></span><span>${escapeHtml(a.size)}</span>`:""}
                    ${a.duration?`<span class="document-info-meta-divider"></span><span>${escapeHtml(a.duration)}</span>`:""}
                </div>
            </div>
        </div>
        <div class="document-toolbar-actions">
            ${n?'<button class="toolbar-btn edit-doc-view"><i class="fas fa-edit"></i> Editar</button>':""}
            ${i?'<button class="toolbar-btn process-doc-view"><i class="fas fa-cogs"></i> Processar</button>':""}
            <button class="toolbar-btn download-doc-view"><i class="fas fa-download"></i> Download</button>
            <button class="toolbar-btn view-doc-modal"><i class="fas fa-eye"></i> Visualizar</button>
        </div>
    `,document.createElement("div")),i=(n.className="document-content",n.innerHTML=`
        <div class="document-container">
            <div class="document-view"></div>
        </div>
    `,n.querySelector(".document-view"));if(i)if("audio"===a.type){let e=null;(e=state.processedAudioBlob&&a.title.startsWith("Gravação_")?state.processedAudioBlob:e)?(a=URL.createObjectURL(e),i.innerHTML=`
                    <div class="audio-player-container">
                        <audio controls src="${a}" class="audio-player"></audio>
                        <p class="audio-note">Use 'Processar' para transcrever.</p>
                    </div>
                `):i.innerHTML=`
                    <div class="audio-player-container">
                        <p class="audio-unavailable">Pré-visualização de áudio não disponível.</p>
                        <p class="audio-note">Use o botão 'Processar' para transcrever.</p>
                    </div>
                `}else{a=document.createElement("pre");a.textContent=o,i.appendChild(a)}e.appendChild(s),e.appendChild(n);o=e.querySelector(".edit-doc-view"),i=(o&&o.addEventListener("click",()=>editDocument(t)),e.querySelector(".process-doc-view")),a=(i&&i.addEventListener("click",()=>startProcessingDocument(t)),e.querySelector(".download-doc-view")),s=(a&&a.addEventListener("click",()=>downloadDocument(t)),e.querySelector(".view-doc-modal"));s&&s.addEventListener("click",()=>viewDocument(t)),gsap.fromTo(e,{opacity:0,y:10},{opacity:1,y:0,duration:.3,ease:"power1.out"})}else showEmptyDocumentView()}function showEmptyDocumentView(){var t=document.getElementById("documentView");if(t){console.log("Mostrando estado vazio do workspace.");let e="Selecione um documento da lista à esquerda para visualizá-lo aqui.";state.currentPatientId?0===state.documents.filter(e=>e.patientId===state.currentPatientId).length&&(e="Nenhum documento encontrado para este paciente. Crie um novo."):e="Selecione um paciente no Dashboard para começar.",t.innerHTML=`
        <div class="document-empty">
            <div class="document-empty-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <h3 class="document-empty-title">Nenhum documento selecionado</h3>
            <p class="document-empty-text">${e}</p>
            ${state.currentPatientId?'<button class="btn btn-primary" id="emptyViewCreateBtn"><i class="fas fa-plus btn-icon"></i> Criar Novo Documento</button>':""}
        </div>
    `;var a=t.querySelector("#emptyViewCreateBtn");a&&a.addEventListener("click",()=>window.switchView("new")),gsap.fromTo(t.querySelector(".document-empty"),{opacity:0,y:10},{opacity:1,y:0,duration:.3,ease:"power1.out"})}}function renderPatientDocuments(){let n=document.getElementById("patientDocuments");var e;n&&state.currentPatientId?(n.innerHTML="",0===(e=state.documents.filter(e=>e.patientId===state.currentPatientId).sort((e,t)=>parseDate(t.date).getTime()-parseDate(e.date).getTime())).length?n.innerHTML='<p class="empty-list-message">Nenhum documento encontrado para este paciente.</p>':e.forEach(t=>{var e=-1!==["transcription","vintra","soap","ipissima","narrative","orientacoes"].indexOf(t.type),a="audio"===t.type||"transcription"===t.type,o=document.createElement("div"),e=(o.className="document-item document-"+t.type,o.dataset.id=t.id,t.id===state.currentDocumentId&&o.classList.add("active"),o.innerHTML=`
            <div class="document-icon">
                <i class="${t.icon}"></i>
            </div>
            <div class="document-info">
                <div class="document-title">
                    ${escapeHtml(t.title)}
                </div>
                <div class="document-meta">
                    ${escapeHtml(t.date)} ${escapeHtml(t.time||"")}
                </div>
            </div>
            <div class="document-actions">
                <button class="document-action-btn view-doc" title="Visualizar"><i class="fas fa-eye"></i></button>
                ${e?'<button class="document-action-btn edit-doc" title="Editar"><i class="fas fa-edit"></i></button>':""}
                ${a?'<button class="document-action-btn process-doc" title="Processar"><i class="fas fa-cogs"></i></button>':""}
                <button class="document-action-btn download-doc" title="Download"><i class="fas fa-download"></i></button>
            </div>
        `,o.querySelector(".view-doc")),a=(e&&e.addEventListener("click",e=>{e.stopPropagation(),viewDocument(t.id)}),o.querySelector(".edit-doc")),e=(a&&a.addEventListener("click",e=>{e.stopPropagation(),editDocument(t.id)}),o.querySelector(".process-doc")),a=(e&&e.addEventListener("click",e=>{e.stopPropagation(),startProcessingDocument(t.id)}),o.querySelector(".download-doc"));a&&a.addEventListener("click",e=>{e.stopPropagation(),downloadDocument(t.id)}),o.addEventListener("click",()=>{setActiveDocumentItem(t.id)}),n.appendChild(o)})):(console.warn("Container de documentos do paciente ou ID do paciente não encontrado."),n&&(n.innerHTML='<p class="empty-list-message">Selecione um paciente para ver seus documentos.</p>'))}function initFluidAnimations(){document.addEventListener("click",function(t){var a=t.target.closest(`
        .btn, .toolbar-btn, .library-btn, .recording-btn,
        .patient-tab, .document-format-option, .dimensional-tab,
        .date-nav-btn, .appointment-action, .mobile-menu-item,
        .sidebar-link, .document-item, .patient-card, .library-filter,
        .document-action-btn, .upload-preview-remove, .modal-close
    `);if(a&&!a.disabled&&!a.classList.contains("disabled")){let e=document.createElement("span");e.classList.add("ripple");var o=a.getBoundingClientRect(),n=Math.max(o.width,o.height),i=t.clientX-o.left-n/2,t=t.clientY-o.top-n/2;e.style.width=e.style.height=n+"px",e.style.left=i+"px",e.style.top=t+"px",a.appendChild(e),e.classList.add("ripple-animation"),e.addEventListener("animationend",()=>{e.remove()})}})}function setupLogin(){let t=document.getElementById("loginForm"),a=document.getElementById("password"),o=document.getElementById("passwordError"),n=document.getElementById("loginScreen"),i=document.getElementById("appContainer");t&&a&&o&&n&&i?t.addEventListener("submit",e=>{e.preventDefault();"123"===a.value?(o.style.display="none",showToast("success","Login bem-sucedido","Bem-vindo ao VINTRA!"),gsap.to(n,{opacity:0,duration:.6,ease:"power2.inOut",onComplete:()=>{n.style.display="none",n.classList.remove("visible"),gsap.set(i,{display:"flex",opacity:0}),gsap.to(i,{opacity:1,duration:.5,ease:"power1.out",onComplete:()=>{state.currentView=null,window.switchView("dashboard")}})}})):(o.style.display="block",gsap.fromTo(t,{x:0},{x:10,duration:.05,repeat:5,yoyo:!0,ease:"power1.inOut",clearProps:"x"}),a.focus(),a.select())}):console.error("Elementos de login não encontrados.")}function logout(){let e=document.getElementById("loginScreen"),t=document.getElementById("appContainer"),a=document.getElementById("password");e&&t&&a&&(showToast("info","Logout","Você saiu da sua conta."),gsap.to(t,{opacity:0,duration:.6,ease:"power2.inOut",onComplete:()=>{t.style.display="none",gsap.set(e,{display:"flex",opacity:0}),e.classList.add("visible"),a.value="",gsap.to(e,{opacity:1,duration:.8,ease:"power2.out"}),state.currentView=null,state.currentPatientId=null,state.currentDocumentId=null,closeMobileMenu()}}))}function setupNavigation(){document.body.addEventListener("click",e=>{var t=e.target.closest("[data-target]");if(t&&t.dataset.target){e.preventDefault();var a=t.dataset.target;switch(a){case"perfil":case"preferencias":showToast("info","Funcionalidade Futura",a.charAt(0).toUpperCase()+a.slice(1)+" ainda não implementado."),closeMobileMenu();break;case"sair":logout();break;default:state.currentView!==a?window.switchView(a):closeMobileMenu()}}})}function updateNavigation(t){document.querySelectorAll(".nav-item[data-target], .sidebar-link[data-target], .mobile-menu-item[data-target]").forEach(e=>{e.dataset.target===t?e.classList.add("active"):e.classList.remove("active")}),closeMobileMenu()}function setupSidebar(){var e=document.getElementById("sidebarToggle");let t=document.querySelector(".app-sidebar");e&&t&&e.addEventListener("click",()=>{t.classList.toggle("expanded"),document.body.classList.toggle("sidebar-expanded",t.classList.contains("expanded"))})}function setupMobileMenu(){var e=document.getElementById("mobileMenuBtn"),t=document.querySelector(".mobile-menu-close"),a=document.getElementById("mobileMenuBackdrop"),o=document.getElementById("mobileMenu");e&&t&&a&&o?(e.addEventListener("click",openMobileMenu),t.addEventListener("click",closeMobileMenu),a.addEventListener("click",closeMobileMenu)):console.error("Elementos do menu mobile não encontrados.")}function openMobileMenu(){var e=document.getElementById("mobileMenu"),t=document.getElementById("mobileMenuBackdrop");e&&t&&(t.classList.add("open"),e.classList.add("open"),document.body.style.overflow="hidden")}function closeMobileMenu(){var e=document.getElementById("mobileMenu"),t=document.getElementById("mobileMenuBackdrop");e&&e.classList.contains("open")&&t&&(e.classList.remove("open"),t.classList.remove("open"),document.body.style.overflow="")}function setupPatientTabs(){var e=document.querySelector("#patient-view .patient-tabs");e&&(e.addEventListener("click",e=>{e=e.target.closest(".patient-tab");e&&e.dataset.panel&&!e.classList.contains("active")&&activatePatientTab(e.dataset.panel)}),e=document.getElementById("backToDashboardBtn"))&&e.addEventListener("click",goBack)}function activatePatientTab(o){if(state.currentPatientId){console.log("Ativando aba do paciente: "+o),state.activePatientTab=o,document.querySelectorAll("#patient-view .patient-tab").forEach(e=>{e.classList.toggle("active",e.dataset.panel===o)});var e=document.querySelector("#patient-view .patient-tab-panels");let t=document.getElementById(o),a=e?e.querySelector(".patient-tab-panel.active"):null;if(t){let e=()=>{gsap.set(t,{display:"block",opacity:0}),t.classList.add("active"),t.scrollTop=0,gsap.to(t,{opacity:1,duration:.3,ease:"power1.out",onComplete:()=>{"summary-panel"===o?updateDimensionalChart():"repository-panel"===o&&renderPatientDocuments()}})};a&&a!==t?gsap.to(a,{opacity:0,duration:.2,ease:"power1.in",onComplete:()=>{a.classList.remove("active"),a.style.display="none",e()}}):a||e()}else console.error("Painel não encontrado: "+o)}}function goBack(){state.currentPatientId=null,window.switchView("dashboard")}function processDocumentWithAI(){var e;state.currentDocumentId?(e=state.documents.find(e=>e.id===state.currentDocumentId))?"transcription"!==e.type&&"audio"!==e.type?showToast("warning","Tipo de Documento Inválido","Apenas transcrições ou áudios podem ser processados."):showToast("info","Processamento IA","Esta funcionalidade será implementada em uma versão futura."):showToast("error","Documento não encontrado","O documento selecionado não foi encontrado."):showToast("warning","Nenhum Documento Selecionado","Por favor, selecione um documento para processar.")}function initCharts(){window.dimensionalChart=null,window.modalChart=null}function updateDimensionalChart(){var e=document.getElementById("dimensionalRadarChart");if(e&&"undefined"!=typeof Chart&&"patient"===state.currentView&&"summary-panel"===state.activePatientTab){console.log("Atualizando gráfico dimensional do paciente..."),window.dimensionalChart instanceof Chart&&window.dimensionalChart.destroy();var t=state.dimensionalData,t={labels:["Valência","Excitação","Dominância","Intensidade","Complexidade","Coerência","Flexibilidade","Dissonância","Persp. Temporal","Autocontrole"],datasets:[{label:"Paciente #"+(state.currentPatientId?state.currentPatientId.replace("patient-",""):"N/A"),data:[t.emocional.valencia,t.emocional.excitacao,t.emocional.dominancia,t.emocional.intensidade,t.cognitiva.complexidade,t.cognitiva.coerencia,t.cognitiva.flexibilidade,t.cognitiva.dissonancia,t.autonomia.perspectivaTemporal.media,t.autonomia.autocontrole],fill:!0,backgroundColor:"rgba(58, 163, 234, 0.2)",borderColor:"rgb(58, 163, 234)",pointBackgroundColor:"rgb(58, 163, 234)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgb(58, 163, 234)"}]};try{var a=e.getContext("2d");a&&(window.dimensionalChart=new Chart(a,{type:"radar",data:t,options:{responsive:!0,maintainAspectRatio:!1,elements:{line:{borderWidth:2}},scales:{r:{angleLines:{display:!0,color:"rgba(0, 0, 0, 0.1)"},grid:{color:"rgba(0, 0, 0, 0.1)"},pointLabels:{font:{size:11}},suggestedMin:-10,suggestedMax:10,ticks:{stepSize:2,backdropColor:"rgba(255, 255, 255, 0.75)",color:"rgba(0, 0, 0, 0.6)"}}},plugins:{legend:{display:!1}}}}))}catch(e){console.error("Erro ao criar gráfico dimensional do paciente:",e),showToast("error","Erro no Gráfico","Não foi possível exibir a análise dimensional.")}}}function setupDimensionalVisualizations(){var e=document.querySelector(".activate-dimensional-space"),t=document.querySelector("#patient-view .dimensional-summary .btn");let a=document.getElementById("dimensionalModal");var o=document.getElementById("dimensionalModalClose"),n=a?a.querySelector(".dimensional-tabs"):null;e&&e.addEventListener("click",showDimensionalModal),t&&t.addEventListener("click",showDimensionalModal),o&&o.addEventListener("click",hideDimensionalModal),a&&a.addEventListener("click",e=>{e.target===a&&hideDimensionalModal()}),n&&n.addEventListener("click",e=>{e=e.target.closest(".dimensional-tab");e&&e.dataset.view&&!e.classList.contains("active")&&activateDimensionalView(e.dataset.view)})}function showDimensionalModal(){var e=document.getElementById("dimensionalModal");e&&(console.log("Mostrando modal dimensional"),gsap.set(e,{display:"flex",opacity:0}),gsap.to(e,{opacity:1,duration:.3,ease:"power1.out",onComplete:()=>{activateDimensionalView("radar")}}),e=e.querySelector(".modal-container"))&&gsap.fromTo(e,{scale:.95,y:10},{scale:1,y:0,duration:.4,ease:"power2.out"})}function hideDimensionalModal(){let e=document.getElementById("dimensionalModal");e&&(console.log("Escondendo modal dimensional"),gsap.to(e,{opacity:0,duration:.3,ease:"power1.in",onComplete:()=>{e.style.display="none",window.modalChart instanceof Chart&&(window.modalChart.destroy(),window.modalChart=null)}}))}function activateDimensionalView(o){var e=document.getElementById("dimensionalModal");if(e&&"none"!==e.style.display){console.log("Ativando visualização dimensional: "+o),state.activeDimensionalView=o;e.querySelectorAll(".dimensional-tabs .dimensional-tab").forEach(e=>{e.classList.toggle("active",e.dataset.view===o)});e=e.querySelector(".dimensional-views");let t=document.getElementById(o+"-view"),a=e?e.querySelector(".dimensional-view.active"):null;if(t){let e=()=>{gsap.set(t,{display:"flex",opacity:0}),t.classList.add("active"),gsap.to(t,{opacity:1,duration:.3,ease:"power1.out",onComplete:()=>{"radar"===o&&updateModalDimensionalChart()}})};a&&a!==t?gsap.to(a,{opacity:0,duration:.2,ease:"power1.in",onComplete:()=>{a.classList.remove("active"),a.style.display="none",e()}}):a||e()}else console.error(`Painel de visualização não encontrado: ${o}-view`)}}function updateModalDimensionalChart(){var e=document.getElementById("modalRadarChart"),t=document.getElementById("dimensionalModal");if(e&&"undefined"!=typeof Chart&&t&&"none"!==t.style.display){console.log("Atualizando gráfico dimensional do modal..."),window.modalChart instanceof Chart&&window.modalChart.destroy();t=state.dimensionalData,t={labels:["Valência","Excitação","Dominância","Intensidade","Complexidade","Coerência","Flexibilidade","Dissonância","Persp. Temporal","Autocontrole"],datasets:[{label:"Análise Dimensional",data:[t.emocional.valencia,t.emocional.excitacao,t.emocional.dominancia,t.emocional.intensidade,t.cognitiva.complexidade,t.cognitiva.coerencia,t.cognitiva.flexibilidade,t.cognitiva.dissonancia,t.autonomia.perspectivaTemporal.media,t.autonomia.autocontrole],fill:!0,backgroundColor:"rgba(58, 163, 234, 0.2)",borderColor:"rgb(58, 163, 234)",pointBackgroundColor:"rgb(58, 163, 234)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgb(58, 163, 234)"}]};try{var a=e.getContext("2d");a&&(window.modalChart=new Chart(a,{type:"radar",data:t,options:{responsive:!0,maintainAspectRatio:!1,elements:{line:{borderWidth:2}},scales:{r:{angleLines:{display:!0,color:"rgba(0, 0, 0, 0.1)"},grid:{color:"rgba(0, 0, 0, 0.1)"},pointLabels:{font:{size:11}},suggestedMin:-10,suggestedMax:10,ticks:{stepSize:2,backdropColor:"rgba(255, 255, 255, 0.75)",color:"rgba(0, 0, 0, 0.6)"}}},plugins:{legend:{display:!0,position:"top"}}}}))}catch(e){console.error("Erro ao criar gráfico dimensional do modal:",e),showToast("error","Erro no Gráfico","Não foi possível exibir a análise dimensional no modal.")}}}function setupDocumentEditing(){let t=document.getElementById("editDocumentModal");var e=document.getElementById("cancelEditBtn"),a=document.getElementById("saveEditBtn"),o=document.getElementById("editModalClose");e&&e.addEventListener("click",closeDocumentEditor),a&&a.addEventListener("click",saveDocumentEdit),o&&o.addEventListener("click",closeDocumentEditor),t&&t.addEventListener("click",e=>{e.target===t&&closeDocumentEditor()})}function openDocumentEditor(e,t,a){console.log(`Abrindo editor para: ${t} (Tipo: ${e})`),state.currentDocumentType=e;var e=document.getElementById("editDocumentModal"),o=document.getElementById("editModalTitle");let n=document.getElementById("documentEditor");e&&o&&n?(o.textContent=t,n.value=a,gsap.set(e,{display:"flex",opacity:0}),gsap.to(e,{opacity:1,duration:.3,ease:"power1.out"}),(o=e.querySelector(".modal-container"))&&gsap.fromTo(o,{scale:.95,y:10},{scale:1,y:0,duration:.4,ease:"power2.out",onComplete:()=>n.focus()})):console.error("Elementos do modal de edição não encontrados.")}function closeDocumentEditor(){let t=document.getElementById("editDocumentModal");t&&"none"!==t.style.display&&(console.log("Fechando editor de documento."),gsap.to(t,{opacity:0,duration:.3,ease:"power1.in",onComplete:()=>{t&&(t.style.display="none");var e=document.getElementById("documentEditor");e&&(e.value=""),state.currentDocumentType=null}}))}function saveDocumentEdit(){var e,t,a=document.getElementById("documentEditor");a&&state.currentDocumentType&&state.currentDocumentId?(a=a.value,e=state.currentDocumentType+"Text",console.log(`Salvando documento: ID ${state.currentDocumentId}, Tipo `+state.currentDocumentType),state.hasOwnProperty(e)?(state[e]=a,console.log(`Conteúdo para ${e} atualizado no estado.`),"library"===state.currentView&&document.querySelector(`#documentView [data-id="${state.currentDocumentId}"]`)?viewDocumentInWorkspace(state.currentDocumentId):"results"===state.currentView&&state.activeResultsTab===state.currentDocumentType+"-panel"?(t=(t=document.getElementById(state.currentDocumentType+"ResultContent")||document.getElementById(state.currentDocumentType+"Content"))?t.querySelector(".document-view"):null)&&(t.innerHTML=`<pre>${escapeHtml(a)}</pre>`):"patient"===state.currentView&&state.activePatientTab,showToast("success","Documento Salvo",`Alterações em '${state.currentDocumentType}' foram salvas.`),closeDocumentEditor()):(console.error("Chave de estado inválida para salvar: "+e),showToast("error","Erro ao Salvar","Tipo de documento inválido."))):(console.error("Não é possível salvar: editor, tipo ou ID do documento ausente."),showToast("error","Erro ao Salvar","Não foi possível identificar o documento a ser salvo."))}function viewDocument(t){var e,a=state.documents.find(e=>e.id===t);a?(console.log("Visualizando (modal genérico): "+a.title),e=`<pre>${escapeHtml(getDocumentContent(a.type)??`Conteúdo para '${a.type}' não disponível.`)}</pre>`,showGenericModal("Visualizar: "+escapeHtml(a.title),e)):showToast("error","Erro","Documento não encontrado.")}function editDocument(t){var e,a=state.documents.find(e=>e.id===t);a?-1!==["transcription","vintra","soap","ipissima","narrative","orientacoes"].indexOf(a.type)?null!==(e=getDocumentContent(a.type))?(state.currentDocumentId=t,openDocumentEditor(a.type,"Editar "+escapeHtml(a.title),e)):showToast("error","Erro",`Conteúdo para '${a.type}' não encontrado.`):showToast("info","Não Editável",`Documentos do tipo '${a.type}' não podem ser editados diretamente.`):showToast("error","Erro","Documento não encontrado.")}function downloadDocument(t){var n=state.documents.find(e=>e.id===t);if(n){console.log("Iniciando download de: "+n.title);let e,t=n.title.includes(".")?n.title:n.title+".txt";if("audio"===n.type)state.processedAudioBlob&&"recording_blob_id"===n.id?e=state.processedAudioBlob:(e=new Blob(["Simulação de conteúdo de áudio."],{type:"audio/wav"}),showToast("info","Download Simulado","Este é um arquivo de áudio simulado.")),t.match(/\.(wav|mp3|ogg|m4a)$/i)||(t=t.replace(/\.[^/.]+$/,"")+".wav");else{var i=getDocumentContent(n.type);if(null===i)return void showToast("error","Erro no Download",`Conteúdo para '${n.type}' não encontrado.`);e=new Blob([i],{type:"text/plain;charset=utf-8"})}let a=URL.createObjectURL(e),o=document.createElement("a");o.href=a,o.download=t,document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(a),showToast("success","Download Iniciado",t+" está sendo baixado.")},100)}else showToast("error","Erro","Documento não encontrado.")}function getDocumentContent(e){var t=e+"Text";return state.hasOwnProperty(t)?state[t]:(console.warn(`Conteúdo para o tipo '${e}' não encontrado no estado.`),null)}function setupNewDocumentTabs(){var e=document.querySelector("#new-view .library-filters"),t=document.getElementById("newDocumentContent");e&&t?(e.addEventListener("click",e=>{e=e.target.closest(".library-filter");e&&e.dataset.newTab&&!e.classList.contains("active")&&activateNewDocumentTab(e.dataset.newTab)}),activateNewDocumentTab(state.activeNewDocumentTab)):console.error("Elementos das abas de 'Novo Documento' não encontrados.")}function activateNewDocumentTab(o){console.log("Ativando aba Novo Documento: "+o),state.activeNewDocumentTab=o;var e=document.querySelector("#new-view .library-filters"),n=document.getElementById("newDocumentContent");if(e&&n){e.querySelectorAll(".library-filter").forEach(e=>{e.classList.toggle("active",e.dataset.newTab===o)});let t=document.getElementById(o+"-tab"),a=n.querySelector(":scope > div.active");if(t){let e=()=>{gsap.set(t,{display:"block",opacity:0}),t.classList.add("active"),t.scrollTop=0,gsap.to(t,{opacity:1,duration:.3,ease:"power1.out",onComplete:()=>{var e;"transcribe"===o&&(e=document.getElementById("transcriptionText"))&&e.focus()}})};a&&a!==t?gsap.to(a,{opacity:0,duration:.2,ease:"power1.in",onComplete:()=>{a.classList.remove("active"),a.style.display="none",e()}}):a||e()}else console.error(`Painel não encontrado: ${o}-tab`)}}function setupRecorder(){var t=document.getElementById("startRecordingBtn"),e=document.getElementById("stopRecordingBtn"),a=document.getElementById("recordingRemoveBtn"),o=document.getElementById("processRecordingBtn");t&&t.addEventListener("click",startRecording),e&&e.addEventListener("click",stopRecording),a&&a.addEventListener("click",resetRecording),o&&o.addEventListener("click",()=>{state.processedAudioBlob?simulateProcessing("recording"):showToast("error","Erro","Nenhuma gravação para processar.")});try{var n=window.AudioContext||window.webkitAudioContext;n&&(state.audioContext=new n,state.analyser=state.audioContext.createAnalyser(),state.analyser.fftSize=256)}catch(e){console.error("Web Audio API não suportada.",e),showToast("warning","Visualizador Indisponível","Seu navegador não suporta a visualização de áudio.");t=document.querySelector(".recording-visualizer");t&&(t.style.display="none")}}async function startRecording(){if(!state.isRecording&&!state.isProcessing){console.log("Tentando iniciar gravação..."),resetRecordingVisuals(),state.audioChunks=[],state.processedAudioBlob=null;try{let e=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});console.log("Acesso ao microfone concedido."),state.mediaRecorder=new MediaRecorder(e),state.mediaRecorder.ondataavailable=e=>{0<e.data.size&&state.audioChunks.push(e.data)},state.mediaRecorder.onstop=()=>{console.log("MediaRecorder parado."),state.processedAudioBlob=new Blob(state.audioChunks,{type:"audio/wav"}),console.log("Blob de áudio criado:",state.processedAudioBlob),state.audioChunks=[],e.getTracks().forEach(e=>e.stop()),console.log("Tracks de áudio paradas."),updateUIAfterRecording()},state.mediaRecorder.start(),state.isRecording=!0,state.recordingStartTime=Date.now(),console.log("MediaRecorder iniciado."),startTimer(),state.audioContext&&state.analyser&&("suspended"===state.audioContext.state&&await state.audioContext.resume(),state.visualizerSource=state.audioContext.createMediaStreamSource(e),state.visualizerSource.connect(state.analyser),startVisualizer(),a=document.querySelector(".recording-visualizer"))&&(a.style.opacity="1"),updateUIRecordingState(!0);var t=document.getElementById("recordingStatus");t&&(t.textContent="Gravando...")}catch(e){console.error("Erro ao iniciar gravação:",e),updateUIRecordingState(state.isRecording=!1);var a=document.getElementById("recordingStatus");a&&(a.textContent="Erro ao iniciar"),"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?showToast("error","Permissão Negada","Você precisa permitir o acesso ao microfone."):"NotFoundError"===e.name||"DevicesNotFoundError"===e.name?showToast("error","Microfone Não Encontrado","Nenhum microfone foi detectado."):showToast("error","Erro na Gravação","Não foi possível iniciar a gravação.")}}}function stopRecording(){if(state.isRecording&&state.mediaRecorder){console.log("Parando gravação...");try{state.mediaRecorder.stop(),state.isRecording=!1,stopTimer(),stopVisualizer(),updateUIRecordingState(!1);var e=document.getElementById("recordingStatus");e&&(e.textContent="Processando gravação...")}catch(e){console.error("Erro ao parar MediaRecorder:",e),resetRecording(),showToast("error","Erro ao Parar","Não foi possível finalizar a gravação corretamente.")}}}function updateUIAfterRecording(){console.log("Atualizando UI pós-gravação.");var e,t,a,o=document.getElementById("recordingPreview"),n=document.getElementById("recordingFileName"),i=document.getElementById("recordingFileMeta"),s=document.getElementById("processRecordingBtn"),r=document.getElementById("recordingStatus");o&&n&&i&&s&&r&&state.processedAudioBlob&&state.recordingStartTime?(e=(Date.now()-state.recordingStartTime)/1e3,t=Math.floor(e/60),e=Math.floor(e%60),t=(a=(e,t)=>{let a=e.toString();for(;a.length<t;)a="0"+a;return a})(t,2)+":"+a(e,2),a=(state.processedAudioBlob.size/1048576).toFixed(1),n.textContent=`Gravação_${(new Date).toISOString().split("T")[0]}.wav`,i.textContent=a+" MB • "+t,gsap.set(o,{display:"flex",opacity:0}),gsap.to(o,{opacity:1,duration:.3}),gsap.set(s,{display:"inline-flex",opacity:0}),gsap.to(s,{opacity:1,duration:.3}),r.textContent="Gravação finalizada"):(console.error("Elementos de preview da gravação não encontrados ou blob/startTime ausente."),resetRecording())}function resetRecording(){if(console.log("Resetando gravação."),state.isRecording){if(state.mediaRecorder&&"recording"===state.mediaRecorder.state)try{state.mediaRecorder.stop()}catch(e){console.error("Erro ao tentar parar mediaRecorder no reset:",e)}state.isRecording=!1}if(stopTimer(),stopVisualizer(),resetRecordingVisuals(),state.audioChunks=[],state.processedAudioBlob=null,state.recordingStartTime=null,state.visualizerSource&&state.visualizerSource.mediaStream&&state.visualizerSource.mediaStream.getTracks().forEach(e=>e.stop()),state.visualizerSource)try{state.visualizerSource.disconnect()}catch(e){console.error("Erro ao desconectar visualizerSource:",e)}state.visualizerSource=null,state.mediaRecorder=null}function resetRecordingVisuals(){var e=document.getElementById("startRecordingBtn"),e=(e&&e.classList.remove("hidden"),document.getElementById("stopRecordingBtn")),e=(e&&e.classList.add("hidden"),document.getElementById("recordingPreview")),e=(e&&(e.style.display="none"),document.getElementById("processRecordingBtn")),e=(e&&(e.style.display="none"),document.getElementById("recordingProgress")),e=(e&&(e.style.display="none"),document.getElementById("recordingTranscriptionSteps")),e=(e&&(e.style.display="none"),document.getElementById("liveTranscriptionPreview")),e=(e&&(e.style.display="none"),document.getElementById("recordingCompletedPanel")),e=(e&&(e.style.display="none"),document.getElementById("recordingTime")),e=(e&&(e.textContent="00:00:00"),document.getElementById("recordingStatus")),e=(e&&(e.textContent="Pronto para gravar"),document.querySelector(".recording-visualizer")),e=(e&&(e.style.opacity="0.3"),document.getElementById("visualizerBars"));e&&(e.innerHTML="")}function updateUIRecordingState(e){var t=document.getElementById("startRecordingBtn"),a=document.getElementById("stopRecordingBtn");t&&t.classList.toggle("hidden",e),a&&a.classList.toggle("hidden",!e)}function startTimer(){state.recordingInterval&&clearInterval(state.recordingInterval);let n=document.getElementById("recordingTime");n&&(state.recordingInterval=window.setInterval(()=>{var e,t,a,o;state.recordingStartTime&&(a=Math.floor((Date.now()-state.recordingStartTime)/1e3),e=Math.floor(a/3600),t=Math.floor(a%3600/60),a=a%60,o=(e,t)=>{let a=e.toString();for(;a.length<t;)a="0"+a;return a},n.textContent=`${o(e,2)}:${o(t,2)}:`+o(a,2))},1e3))}function stopTimer(){state.recordingInterval&&(clearInterval(state.recordingInterval),state.recordingInterval=null)}function startVisualizer(){if(state.analyser&&state.audioContext&&"suspended"!==state.audioContext.state&&state.visualizerSource){let r=document.getElementById("visualizerBars");if(r){r.innerHTML="";let t=state.analyser.frequencyBinCount,i=new Uint8Array(t);for(let e=0;e<30;e++){var o=document.createElement("div");o.className="visualizer-bar",r.appendChild(o)}let s=r.childNodes,a=()=>{if(state.isRecording&&state.analyser){state.visualizerRafId=requestAnimationFrame(a),state.analyser.getByteFrequencyData(i);var e=r.clientHeight/128,o=Math.floor(t/30);for(let a=0;a<30;a++){let t=0;for(let e=0;e<o;e++)t+=i[a*o+e];var n=t/o||0,n=Math.max(1,Math.min(n*e*1.5,r.clientHeight));s[a]&&(s[a].style.height=n+"px")}}else stopVisualizer()};state.visualizerRafId&&cancelAnimationFrame(state.visualizerRafId),state.visualizerRafId=null,a()}}else console.warn("AudioContext/Analyser/Source não disponível/pronto, não iniciando visualizador.")}function stopVisualizer(){state.visualizerRafId&&(cancelAnimationFrame(state.visualizerRafId),state.visualizerRafId=null),document.getElementById("visualizerBars")&&gsap.to(".visualizer-bar",{height:1,duration:.3,ease:"power1.out",stagger:.01}),console.log("Visualizador parado.")}function setupUpload(){let t=document.getElementById("uploadArea"),e=document.getElementById("uploadInput");var a=document.getElementById("uploadRemoveBtn"),o=document.getElementById("processUploadBtn");t&&e&&a&&o?(t.addEventListener("click",()=>e.click()),["dragenter","dragover","dragleave","drop"].forEach(e=>{t.addEventListener(e,preventDefaults,!1),document.body.addEventListener(e,preventDefaults,!1)}),["dragenter","dragover"].forEach(e=>{t.addEventListener(e,()=>t.classList.add("dragover"),!1)}),["dragleave","drop"].forEach(e=>{t.addEventListener(e,()=>t.classList.remove("dragover"),!1)}),t.addEventListener("drop",e=>{e=e.dataTransfer?.files;e?.length&&handleFiles(e)},!1),e.addEventListener("change",e=>{e=e.target;e.files?.length&&handleFiles(e.files)}),a.addEventListener("click",resetUpload),o.addEventListener("click",()=>{state.uploadedFile?simulateProcessing("upload"):showToast("error","Erro","Nenhum arquivo selecionado para processar.")})):console.error("Elementos de upload não encontrados.")}function preventDefaults(e){e.preventDefault(),e.stopPropagation()}function handleFiles(e){var t,a,o,n,i;1<e.length?showToast("warning","Apenas um arquivo","Por favor, envie apenas um arquivo por vez."):(e=e[0]).type.startsWith("audio/")||"text/plain"===e.type?(console.log("Arquivo selecionado:",e.name,e.size,e.type),state.uploadedFile=e,t=document.getElementById("uploadPreview"),a=document.getElementById("uploadFileName"),o=document.getElementById("uploadFileMeta"),n=document.getElementById("processUploadBtn"),i=t?.querySelector(".upload-preview-icon i"),t&&a&&o&&n&&i&&(a.textContent=escapeHtml(e.name),o.textContent=(e.size/1048576).toFixed(1)+" MB",e.type.startsWith("audio/")?i.className="fas fa-file-audio":"text/plain"===e.type?i.className="fas fa-file-alt":i.className="fas fa-file",gsap.set(t,{display:"flex",opacity:0}),gsap.to(t,{opacity:1,duration:.3}),gsap.set(n,{display:"inline-flex",opacity:0}),gsap.to(n,{opacity:1,duration:.3})),uploadInput&&(uploadInput.value="")):(showToast("warning","Tipo Inválido","Apenas arquivos de áudio ou texto plano são suportados."),resetUpload())}function resetUpload(){console.log("Resetando upload."),state.uploadedFile=null;let e=document.getElementById("uploadPreview"),t=document.getElementById("processUploadBtn");var a=document.getElementById("uploadProgress"),o=document.getElementById("uploadTranscriptionSteps"),n=document.getElementById("uploadCompletedPanel"),i=document.getElementById("uploadInput");e&&gsap.to(e,{opacity:0,duration:.2,onComplete:()=>e.style.display="none"}),t&&gsap.to(t,{opacity:0,duration:.2,onComplete:()=>t.style.display="none"}),a&&(a.style.display="none"),o&&(o.style.display="none"),n&&(n.style.display="none"),i&&(i.value="")}function setupTranscriptionInput(){var e=document.getElementById("processManualTranscriptionBtn");let t=document.getElementById("transcriptionText");e&&t&&e.addEventListener("click",()=>{var e=t.value.trim();e?(state.transcriptionText=e,simulateProcessing("manual")):(showToast("warning","Texto Vazio","Por favor, digite ou cole a transcrição."),t.focus())})}function setProcessingState(t){state.isProcessing=t,document.querySelectorAll(`
        .sidebar-link, .mobile-menu-item, #sidebarToggle, #mobileMenuBtn,
        .library-btn, .document-item, .toolbar-btn, .patient-tab,
        #startRecordingBtn, #stopRecordingBtn, #processRecordingBtn,
        #uploadArea, #uploadInput, #processUploadBtn,
        #processManualTranscriptionBtn, #startProcessingBtn,
        .document-format-option, .dimensional-tab, .modal-close, .modal-footer button,
        .document-action-btn, .nav-item
    `).forEach(e=>{"BUTTON"!==e.tagName&&"INPUT"!==e.tagName||(e.disabled=t),e.classList.toggle("disabled",t)}),console.log("Estado de processamento: "+t)}async function simulateProcessing(o){if(!state.isProcessing){setProcessingState(!0),console.log("Simulando processamento para: "+o);var n=o+"TranscriptionSteps",i=o+"TranscriptionStepsProgress",s=o+"CompletedPanel",r=o+"ProgressBar",c=o+"ProgressPercentage",d=o+"ProgressStatus",l=o+"Preview",u="recording"===o?"processRecordingBtn":"upload"===o?"processUploadBtn":"processManualTranscriptionBtn",m=document.getElementById(o+"Progress"),p=document.getElementById(n),s=document.getElementById(s);let e=document.getElementById(l),t=document.getElementById(u);var v=document.getElementById("liveTranscriptionPreview"),l=document.getElementById("transcriptionText"),g=(t&&gsap.to(t,{opacity:0,duration:.2,onComplete:()=>t.style.display="none"}),e&&"manual"!==o&&gsap.to(e,{opacity:0,duration:.2,onComplete:()=>e.style.display="none"}),"manual"===o&&l&&(l.disabled=!0),m&&(m.style.display="block"),p&&(p.style.display="block"),!v||"recording"!==o&&"upload"!==o||(v.style.display="block",v.innerHTML="<p>Iniciando análise...</p>"),[{name:"upload"===o?"Upload":"manual"===o?"Validação":"Processando Áudio",duration:1e3,text:"Analisando dados..."},{name:"manual"===o?"Processamento":"Transcrição",duration:2e3,text:"Realizando transcrição..."},{name:"manual"===o?"Análise":"Diarização",duration:1500,text:"Identificando segmentos..."},{name:"Finalização",duration:500,text:"Gerando documento..."}]),y=g.reduce((e,t)=>e+t.duration,0);let a=0;u=state.transcriptionText||`Transcrição simulada para ${o} - ${(new Date).toLocaleTimeString()}. Médico: ... Paciente: ...`;state.transcriptionText=u;for(let e=0;e<g.length;e++){let t=g[e];updateStepProgress(n,i,e+1),updateProgressBar(r,c,d,a/y*100,t.name),!v||"recording"!==o&&"upload"!==o||(v.innerHTML=`<p>${t.text}</p>`,v.scrollTop=v.scrollHeight),await new Promise(e=>setTimeout(e,t.duration)),a+=t.duration,e<g.length-1&&updateStepProgress(n,i,e+1,!0)}updateProgressBar(r,c,d,100,"Concluído"),updateStepProgress(n,i,g.length,!0),!v||"recording"!==o&&"upload"!==o||(v.innerHTML="<p>Transcrição finalizada.</p>");u=addProcessedDocument(("upload"===o?state.uploadedFile?.name:"recording"===o?document.getElementById("recordingFileName")?.textContent:"Transcricao_Manual")||"Documento",o);u?(state.currentDocumentId=u,m&&(m.style.display="none"),p&&(p.style.display="none"),v&&(v.style.display="none"),s&&(s.classList.add("active"),s.style.display="flex"),"manual"===o&&l&&(l.disabled=!1),setProcessingState(!1),console.log(`Processamento de ${o} concluído. Novo Documento ID: `+u)):(console.error("Falha ao criar ID para o novo documento de transcrição."),setProcessingState(!1),showToast("error","Erro Interno","Não foi possível salvar a transcrição processada."),"recording"===o?resetRecording():"upload"===o?resetUpload():"manual"===o&&l&&(l.disabled=!1))}}function addProcessedDocument(e,t){var a=new Date,o=a.toLocaleDateString("pt-BR"),a=a.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),e=e.replace(/\.[^/.]+$/,"");let n="doc"+Date.now();var i=state.transcriptionText?(state.transcriptionText.length/1024).toFixed(1):"0.0",e={id:n,patientId:state.currentPatientId||null,title:`Transcrição_${e}.txt`,type:"transcription",date:o,time:a,icon:"fas fa-file-alt",color:"var(--accent)",size:i+" KB"};return state.documents.some(e=>e.id===n)?(console.error("Erro: Tentativa de adicionar documento com ID duplicado:",n),null):(state.documents.push(e),console.log("Novo documento de transcrição adicionado:",e),"library"===state.currentView&&renderDocumentLibrary(),"patient"===state.currentView&&"repository-panel"===state.activePatientTab&&renderPatientDocuments(),n)}function updateStepProgress(e,t,a,o=!1){var e=document.getElementById(e),t=document.getElementById(t);e&&t&&((e=e.querySelectorAll(".transcription-step")).forEach((e,t)=>{t+=1;e.classList.remove("active","completed"),t<a||t===a&&o?e.classList.add("completed"):t!==a||o||e.classList.add("active")}),e=o?a/e.length*100:(a-.5)/e.length*100,t.style.width=Math.min(100,e)+"%")}function updateProgressBar(e,t,a,o,n){e=document.getElementById(e),t=document.getElementById(t),a=document.getElementById(a);e&&(e.style.width=Math.min(o,100)+"%"),t&&(t.textContent=Math.round(Math.min(o,100))+"%"),a&&(a.textContent=n)}function setupProcessing(){let t=document.querySelector("#processing-view .document-format-options");var e=document.getElementById("startProcessingBtn");t&&t.addEventListener("click",e=>{e=e.target.closest(".document-format-option");e&&e.classList.toggle("active")}),e&&e.addEventListener("click",()=>{var e;t&&(0===(e=Array.from(t.querySelectorAll(".document-format-option.active")).map(e=>e.dataset.format).filter(e=>e)).length?showToast("warning","Nenhum Formato","Selecione pelo menos um formato para gerar."):state.currentDocumentId?simulateGeneration(e):(showToast("error","Erro","Nenhum documento base selecionado para processamento."),window.switchView("library")))})}async function simulateGeneration(t){if(!state.isProcessing){setProcessingState(!0),console.log("Simulando geração para formatos: "+t.join(", "));var a,o=document.getElementById("processingProgress"),n=document.getElementById("processingCompletedPanel"),i=document.getElementById("startProcessingBtn"),s=document.querySelector("#processing-view .document-format-options"),r=(i&&(i.style.display="none"),s&&(s.style.display="none"),o&&(o.style.display="block"),t.length);let e=0;for(a of t){e++;var c=`Gerando ${a.charAt(0).toUpperCase()+a.slice(1)}... (${e}/${r})`;updateProgressBar("processingProgressBar","processingProgressPercentage","processingProgressStatus",e/r*100,c),await new Promise(e=>setTimeout(e,1500)),addGeneratedDocument(a)}updateProgressBar("processingProgressBar","processingProgressPercentage","processingProgressStatus",100,"Concluído"),o&&(o.style.display="none"),n&&(n.classList.add("active"),n.style.display="flex"),setProcessingState(!1),console.log("Geração de documentos concluída.")}}function addGeneratedDocument(o){var n=state.documents.find(e=>e.id===state.currentDocumentId);if(n){var i=new Date,s=i.toLocaleDateString("pt-BR"),i=i.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}),r=n.title.replace(/\.(txt|mp3|wav|m4a)$/i,"");let t=`doc${Date.now()}_`+o,e="fas fa-file-medical-alt",a="var(--gray-600)";switch(o){case"vintra":e="fas fa-clipboard-list",a="var(--accent)";break;case"soap":e="fas fa-notes-medical",a="var(--success)";break;case"ipissima":e="fas fa-comment-dots",a="var(--accent-pink)";break;case"narrative":e="fas fa-book-open",a="var(--warning-yellow)";break;case"orientacoes":e="fas fa-list-check",a="#8B5CF6"}var c=getDocumentContent(o);null===c?console.error(`Conteúdo de exemplo para '${o}' não encontrado.`):(c=(c.length/1024).toFixed(1),n={id:t,patientId:n.patientId,title:o.toUpperCase()+`_${r}.txt`,type:o,date:s,time:i,icon:e,color:a,size:c+" KB"},state.documents.some(e=>e.id===t)?console.warn(`Documento com ID ${t} já existe. Geração ignorada.`):(state.documents.push(n),console.log(`Novo documento gerado (${o}) adicionado:`,n),"library"===state.currentView&&renderDocumentLibrary(),"patient"===state.currentView&&"repository-panel"===state.activePatientTab&&renderPatientDocuments(),state.currentView))}else console.error("Documento base não encontrado para gerar formato:",o)}function startProcessingDocument(t){var e,a,o,n=state.documents.find(e=>e.id===t);n?"audio"!==n.type&&"transcription"!==n.type?showToast("info","Não Processável",`Documentos do tipo '${n.type}' não podem ser usados para gerar formatos VINTRA.`):(console.log("Iniciando fluxo de processamento para: "+n.title),state.currentDocumentId=t,(e=document.getElementById("processingDocumentTitle"))&&(e.textContent=escapeHtml(n.title)),e=document.querySelector("#processing-view .document-format-options"),n=document.getElementById("startProcessingBtn"),a=document.getElementById("processingProgress"),o=document.getElementById("processingCompletedPanel"),e&&(e.style.display="flex",e.querySelectorAll(".document-format-option").forEach(e=>{var t=e.dataset.format;e.classList.toggle("active","vintra"===t||"soap"===t)})),n&&(n.style.display="inline-flex"),a&&(a.style.display="none"),o&&(o.style.display="none"),window.switchView("processing")):showToast("error","Erro","Documento não encontrado.")}function setupResultsView(){var e=document.querySelector("#results-view .document-tabs"),t=document.getElementById("downloadResultsBtn"),a=document.getElementById("editResultBtn");e&&e.addEventListener("click",e=>{e=e.target.closest(".document-tab");e&&e.dataset.panel&&!e.classList.contains("active")&&activateResultsTab(e.dataset.panel)}),t&&t.addEventListener("click",()=>{let t=state.activeResultsTab.replace("-panel","");var e=state.documents.filter(e=>e.type===t&&e.patientId===state.currentPatientId).sort((e,t)=>parseDate(t.date,t.time).getTime()-parseDate(e.date,e.time).getTime())[0];e?downloadDocument(e.id):showToast("warning","Download Indisponível",`Não foi possível encontrar o documento '${t}' para download.`)}),a&&a.addEventListener("click",()=>{let t=state.activeResultsTab.replace("-panel","");var e=state.documents.filter(e=>e.type===t&&e.patientId===state.currentPatientId).sort((e,t)=>parseDate(t.date,t.time).getTime()-parseDate(e.date,e.time).getTime())[0];e?editDocument(e.id):showToast("warning","Edição Indisponível",`Não foi possível encontrar o documento '${t}' para edição.`)})}function activateResultsTab(t){console.log("Ativando aba de resultados: "+t),state.activeResultsTab=t,document.querySelectorAll("#results-view .document-tab").forEach(e=>{e.classList.toggle("active",e.dataset.panel===t)});var a=document.querySelector("#results-view .document-tab-panels");let o=document.getElementById(t),n=a?.querySelector(".document-tab-panel.active");if(o){var a=t.replace("-panel",""),i=getDocumentContent(a)??`Conteúdo para '${a}' não disponível.`,s=o.querySelector(".document-view"),s=(s?s.innerHTML=`<pre>${escapeHtml(i)}</pre>`:(console.warn("Elemento .document-view não encontrado em #"+t),o.innerHTML=`<div class="document-content"><div class="document-container"><div class="document-view"><pre>${escapeHtml(i)}</pre></div></div></div>`),document.getElementById("editResultBtn"));s&&(i=-1!==["transcription","vintra","soap","ipissima","narrative","orientacoes"].indexOf(a),s.disabled=!i,s.style.display=i?"inline-flex":"none");let e=()=>{gsap.set(o,{display:"block",opacity:0}),o.classList.add("active"),o.scrollTop=0,gsap.to(o,{opacity:1,duration:.3,ease:"power1.out"})};n&&n!==o?gsap.to(n,{opacity:0,duration:.2,ease:"power1.in",onComplete:()=>{n.classList.remove("active"),n.style.display="none",e()}}):n||e()}else console.error("Painel de resultados não encontrado: "+t)}function setupDocumentLibrary(){let a=document.querySelector("#library-view .library-filters"),o=document.querySelector("#library-view .library-search-input");a&&a.addEventListener("click",e=>{var t,e=e.target.closest(".library-filter");e&&!e.classList.contains("active")&&((t=a.querySelector(".library-filter.active"))&&t.classList.remove("active"),e.classList.add("active"),renderDocumentLibrary(e.dataset.filter||"all",o?.value||""))}),o&&o.addEventListener("input",debounce(()=>{renderDocumentLibrary(a?.querySelector(".library-filter.active")?.dataset.filter||"all",o.value)},300))}function showToast(a,o,n,i=5e3){var s=document.getElementById("toastContainer");if(s){let e=document.createElement("div"),t=(e.className="toast toast-"+a,"fas fa-info-circle");"success"===a?t="fas fa-check-circle":"error"===a?t="fas fa-times-circle":"warning"===a&&(t="fas fa-exclamation-triangle"),e.innerHTML=`
        <div class="toast-icon">
            <i class="${t}"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">
                ${escapeHtml(o)}
            </div>
            <div class="toast-message">
                ${escapeHtml(n)}
            </div>
        </div>
        <button class="toast-close"><i class="fas fa-times"></i></button>
    `;a=e.querySelector(".toast-close");a&&a.addEventListener("click",()=>removeToast(e)),s.appendChild(e),gsap.fromTo(e,{opacity:0,y:20,scale:.9},{opacity:1,y:0,scale:1,duration:.4,ease:"power2.out"}),setTimeout(()=>removeToast(e),i)}}function removeToast(e){e?.parentNode&&gsap.to(e,{opacity:0,y:10,scale:.9,duration:.3,ease:"power1.in",onComplete:()=>{e.parentNode&&e.parentNode.removeChild(e)}})}function setupGenericModal(){let t=document.getElementById("genericModal");var e=document.getElementById("genericModalClose"),a=document.getElementById("genericModalCancelBtn");e&&e.addEventListener("click",hideGenericModal),a&&a.addEventListener("click",hideGenericModal),t&&t.addEventListener("click",e=>{e.target===t&&hideGenericModal()})}function showGenericModal(e,t){var a=document.getElementById("genericModal"),o=document.getElementById("genericModalTitle"),n=document.getElementById("genericModalBody");a&&o&&n?(o.textContent=e,n.innerHTML=t,gsap.set(a,{display:"flex",opacity:0}),gsap.to(a,{opacity:1,duration:.3,ease:"power1.out"}),(o=a.querySelector(".modal-container"))&&gsap.fromTo(o,{scale:.95,y:10},{scale:1,y:0,duration:.4,ease:"power2.out"})):console.error("Elementos do modal genérico não encontrados.")}function hideGenericModal(){let t=document.getElementById("genericModal");t&&"none"!==t.style.display&&gsap.to(t,{opacity:0,duration:.3,ease:"power1.in",onComplete:()=>{t&&(t.style.display="none");var e=document.getElementById("genericModalBody");e&&(e.innerHTML="")}})}function debounce(t,a){let o=null;return function(...e){null!==o&&clearTimeout(o),o=window.setTimeout(()=>{o=null,t(...e)},a)}}function escapeHtml(e){if("string"!=typeof e)try{e=String(e)}catch(e){return""}return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function parseDate(e,t){var a,o=e.split("/"),n=parseInt(o[0],10),i=parseInt(o[1],10)-1,o=parseInt(o[2],10);let s=0,r=0;return t&&(a=t.split(":"),s=parseInt(a[0],10),r=parseInt(a[1],10)),isNaN(n)||isNaN(i)||isNaN(o)||isNaN(s)||isNaN(r)?(console.warn(`Data/hora inválida encontrada: ${e} ${t||""}. Retornando data atual.`),new Date):new Date(o,i,n,s,r)}function viewTranscription(){if(state.currentDocumentId){let e=state.documents.find(e=>e.id===state.currentDocumentId&&"transcription"===e.type);e?(window.switchView("library"),setTimeout(()=>{setActiveDocumentItem(e.id),viewDocumentInWorkspace(e.id)},400)):(showToast("error","Erro","Transcrição não encontrada na biblioteca."),window.switchView("library"))}else showToast("warning","Nenhum Documento","Nenhum documento de transcrição ativo para visualizar."),window.switchView("library")}function processTranscription(){var e;state.currentDocumentId?(e=state.documents.find(e=>e.id===state.currentDocumentId&&"transcription"===e.type))?startProcessingDocument(e.id):(showToast("error","Erro","Documento de transcrição não encontrado para processar."),window.switchView("library")):(showToast("warning","Nenhum Documento","Nenhum documento de transcrição ativo para processar."),window.switchView("library"))}document.addEventListener("DOMContentLoaded",()=>{console.log("VINTRA Inicializando..."),loadDemoData(),setupEventListeners(),initCharts(),initFluidAnimations();let e=document.getElementById("splashScreen"),t=document.getElementById("loginScreen");var a=document.getElementById("appContainer");e&&t&&a?(gsap.set(e,{display:"flex",opacity:1}),gsap.to(e,{opacity:0,duration:.5,delay:.7,ease:"power1.inOut",onComplete:()=>{e.style.display="none",gsap.set(t,{display:"flex",opacity:0}),t.classList.add("visible"),gsap.to(t,{opacity:1,duration:.5,ease:"power1.out"})}})):(console.warn("Splash, Login ou App Container não encontrados. Exibindo App diretamente."),a&&(a.style.display="flex"),window.switchView("dashboard")),renderPatientSelectionOnDashboard()}),window.switchView=function(o,e=!1){let n=document.getElementById(o+"-view");if(n)if(state.currentView!==o||e)if(state.isProcessing)showToast("warning","Processo em andamento","Por favor, aguarde a conclusão do processo atual.");else if("library"!==o&&"new"!==o&&"processing"!==o&&"results"!==o||state.currentPatientId){console.log("Trocando para view: "+o);let e=state.currentView?document.getElementById(state.currentView+"-view"):null,t="library"===o||"patient"===o||"results"===o||"processing"===o?"flex":"block",a=()=>{gsap.set(n,{display:t,opacity:0,y:15}),n.scrollTop=0,gsap.to(n,{opacity:1,y:0,duration:.4,ease:"power2.out",onComplete:()=>{switch(o){case"patient":activatePatientTab(state.activePatientTab||"summary-panel");break;case"library":renderDocumentLibrary(),state.currentDocumentId?viewDocumentInWorkspace(state.currentDocumentId):showEmptyDocumentView();break;case"dashboard":renderPatientSelectionOnDashboard();break;case"results":activateResultsTab(state.activeResultsTab||"transcription-panel");break;case"new":activateNewDocumentTab(state.activeNewDocumentTab||"record")}}}),updateNavigation(state.currentView=o)};e?gsap.to(e,{opacity:0,y:-15,duration:.3,ease:"power2.in",onComplete:()=>{e.style.display="none",e.style.transform="",a()}}):a()}else showToast("warning","Selecione um Paciente","Por favor, selecione um paciente no dashboard para acessar esta funcionalidade."),window.switchView("dashboard");else console.log("Já está na view: "+o),closeMobileMenu();else console.error(`View não encontrada: ${o}-view`),showToast("error","Erro de Navegação",`A view '${o}' não existe.`)},window.openPatientPanel=function(t){var e,a,o=state.recentPatients.find(e=>e.id===t);o?(console.log(`Abrindo painel para paciente: ${o.name} (ID: ${t})`),state.currentPatientId=t,e=document.querySelector("#patient-view .patient-name"),a=document.querySelector("#patient-view .patient-details"),e&&(e.textContent=escapeHtml(o.name)),a&&(a.textContent=`${escapeHtml(String(o.age))} anos • ${escapeHtml(o.gender)} • Prontuário #`+escapeHtml(t.replace("patient-",""))),state.activePatientTab="summary-panel",window.switchView("patient")):showToast("error","Erro","Paciente não encontrado.")};